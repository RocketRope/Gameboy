INCLUDE "def_gb.z80"

SECTION "rom", ROM0

; $0000 - $003F: RST handlers.

; $0040 - $0067: Interrupt handlers.
SECTION "Vblank", ROM0[$0040]
jp vblank
SECTION "LCDC", ROM0[$0048]
reti
SECTION "Timer_Overflow", ROM0[$0050]
reti
SECTION "Serial", ROM0[$0058]
reti
SECTION "p1thru4", ROM0[$0060] 
reti

; $0068 - $00FF: Free space.
DS $98

; $0100 - $0103: Startup handler.
SECTION "start", ROM0[$0100]
nop
jp main

; $0104 - $0133: The Nintendo Logo.
DB $CE, $ED, $66, $66, $CC, $0D, $00, $0B
DB $03, $73, $00, $83, $00, $0C, $00, $0D
DB $00, $08, $11, $1F, $88, $89, $00, $0E
DB $DC, $CC, $6E, $E6, $DD, $DD, $D9, $99
DB $BB, $BB, $67, $63, $6E, $0E, $EC, $CC
DB $DD, $DC, $99, $9F, $BB, $B9, $33, $3E

; $0134 - $013E: The title, in upper-case letters, followed by zeroes.
DB "TEST"
DS 7 ; padding

; $013F - $0142: The manufacturer code.
DS 4

; $0143: Gameboy Color compatibility flag.
DB GBC_UNSUPPORTED

; $0144 - $0145: "New" Licensee Code, a two character name.
DB "OK"

; $0146: Super Gameboy compatibility flag.
DB SGB_UNSUPPORTED

; $0147: Cartridge type. Either no ROM or MBC5 is recommended.
DB CART_ROM_ONLY

; $0148: Rom size.
DB ROM_32K

; $0149: Ram size.
DB RAM_NONE

; $014A: Destination code.
DB DEST_INTERNATIONAL
; $014B: Old licensee code.
DB $33
; $014C: ROM version number
DB $00
; $014D: Header checksum.
; Assembler needs to patch this.
DB $FF
; $014E- $014F: Global checksum.
; Assembler needs to patch this.
DW $FACE

SECTION "code", ROM0[$0150]

main:

    ; Stackpointer
    ld sp, $FFFF

    call load_font_table

    ; Background palette
    ld a, %11100100
    ld [$FF47], a

    ; Save original SCX and SCY
    ld a, [$FF43]
    ld [$C001], a
    ld a, [$FF42]
    ld [$C002], a

    ; Enable vblank interupt
    ld a, $01
    ld [$FFFF], a

    ei

.loop:
    nop
    jr .loop

vblank:
    
vblank_done:

    reti

read_input:

    ; Dpad
    ld a, %11101111
    ld [$FF00], a

    ld   a, [$FF00]
    ld   a, [$FF00]
    and  a, $0F

    swap a
    ld   b, a

    ; Buttons
    ld a, %11011111
    ld [$FF00], a

    ld   a, [$FF00]
    ld   a, [$FF00]
    and  a, $0F
    
    or   a, b
    cpl
    ld   [$C000], a

    ret

; Copy from [de] to [hl] in range [de]->[bc]
mem_copy:

    ld a, [$FF44]
    cp a, 144
    jp c, mem_copy

    ld a, [de]
    ld [hl+], a
    inc de

    ld a, e
    cp a, c
    jp nz, mem_copy
    ld a, d
    cp a, b
    jp nz, mem_copy

    ret

load_font_table:

    ld hl, $8000 + ($20 * $10)
    ld de, font_table
    ld bc, font_table_end

    call mem_copy

    ld hl, $9800
    ld de, string
    ld bc, string_end

    call mem_copy

    ret

string:
    DB "!\"#%&! 1234567890"
string_end:

font_table:
	DW `00000000, `00000000, `00000000, `00000000, `00000000, `00000000, `00000000, `00000000 ; Space
	DW `00033000, `00333300, `00333300, `00033000, `00033000, `00000000, `00033000, `00000000 ; !
	DW `03303300, `03303300, `00000000, `00000000, `00000000, `00000000, `00000000, `00000000 ; "
	DW `03303300, `03303300, `33333330, `03303300, `33333330, `03303300, `03303300, `00000000 ; #
	DW `00330000, `03333300, `33000000, `03333000, `00003300, `33333000, `00330000, `00000000 ; $
	DW `00000000, `33000330, `33003300, `00033000, `00330000, `03300330, `33000330, `00000000 ; %
	DW `00333000, `03303300, `00333000, `03330330, `33033300, `33003300, `03330330, `00000000 ; &
	DW `03300000, `03300000, `33000000, `00000000, `00000000, `00000000, `00000000, `00000000 ; '
	DW `00033000, `00330000, `03300000, `03300000, `03300000, `00330000, `00033000, `00000000 ; (
	DW `03300000, `00330000, `00033000, `00033000, `00033000, `00330000, `03300000, `00000000 ; )
	DW `00000000, `03300330, `00333300, `33333333, `00333300, `03300330, `00000000, `00000000 ; *
	DW `00000000, `00330000, `00330000, `33333300, `00330000, `00330000, `00000000, `00000000 ; +
	DW `00000000, `00000000, `00000000, `00000000, `00000000, `00330000, `00330000, `03300000 ; ,
	DW `00000000, `00000000, `00000000, `33333300, `00000000, `00000000, `00000000, `00000000 ; -
	DW `00000000, `00000000, `00000000, `00000000, `00000000, `00330000, `00330000, `00000000 ; .
	DW `00000330, `00003300, `00033000, `00330000, `03300000, `33000000, `30000000, `00000000 ; /
	DW `03333300, `33000330, `33003330, `33033330, `33330330, `33300330, `03333300, `00000000 ; 0
	DW `00330000, `03330000, `00330000, `00330000, `00330000, `00330000, `33333300, `00000000 ; 1
	DW `03333000, `33003300, `00003300, `00333000, `03300000, `33003300, `33333300, `00000000 ; 2
	DW `03333000, `33003300, `00003300, `00333000, `00003300, `33003300, `03333000, `00000000 ; 3
	DW `00033300, `00333300, `03303300, `33003300, `33333330, `00003300, `00033330, `00000000 ; 4
	DW `33333300, `33000000, `33333000, `00003300, `00003300, `33003300, `03333000, `00000000 ; 5
	DW `00333000, `03300000, `33000000, `33333000, `33003300, `33003300, `03333000, `00000000 ; 6
	DW `33333300, `33003300, `00003300, `00033000, `00330000, `00330000, `00330000, `00000000 ; 7
	DW `03333000, `33003300, `33003300, `03333000, `33003300, `33003300, `03333000, `00000000 ; 8
	DW `03333000, `33003300, `33003300, `03333300, `00003300, `00033000, `03330000, `00000000 ; 9
	DW `00000000, `00330000, `00330000, `00000000, `00000000, `00330000, `00330000, `00000000 ; :
	DW `00000000, `00330000, `00330000, `00000000, `00000000, `00330000, `00330000, `03300000 ; ;
	DW `00033000, `00330000, `03300000, `33000000, `03300000, `00330000, `00033000, `00000000 ; <
	DW `00000000, `00000000, `33333300, `00000000, `00000000, `33333300, `00000000, `00000000 ; =
	DW `03300000, `00330000, `00033000, `00003300, `00033000, `00330000, `03300000, `00000000 ; >
	DW `03333000, `33003300, `00003300, `00033000, `00330000, `00000000, `00330000, `00000000 ; ?
	DW `03333300, `33000330, `33033330, `33033330, `33033330, `33000000, `03333000, `00000000 ; @
	DW `00330000, `03333000, `33003300, `33003300, `33333300, `33003300, `33003300, `00000000 ; A
	DW `33333300, `03300330, `03300330, `03333300, `03300330, `03300330, `33333300, `00000000 ; B
	DW `00333300, `03300330, `33000000, `33000000, `33000000, `03300330, `00333300, `00000000 ; C
	DW `33333000, `03303300, `03300330, `03300330, `03300330, `03303300, `33333000, `00000000 ; D
	DW `33333330, `03300030, `03303000, `03333000, `03303000, `03300030, `33333330, `00000000 ; E
	DW `33333330, `03300030, `03303000, `03333000, `03303000, `03300000, `33330000, `00000000 ; F
	DW `00333300, `03300330, `33000000, `33000000, `33003330, `03300330, `00333330, `00000000 ; G
	DW `33003300, `33003300, `33003300, `33333300, `33003300, `33003300, `33003300, `00000000 ; H
	DW `03333000, `00330000, `00330000, `00330000, `00330000, `00330000, `03333000, `00000000 ; I
	DW `00033330, `00003300, `00003300, `00003300, `33003300, `33003300, `03333000, `00000000 ; J
	DW `33300330, `03300330, `03303300, `03333000, `03303300, `03300330, `33300330, `00000000 ; K
	DW `33330000, `03300000, `03300000, `03300000, `03300030, `03300330, `33333330, `00000000 ; L
	DW `33000330, `33303330, `33333330, `33333330, `33030330, `33000330, `33000330, `00000000 ; M
	DW `33000330, `33300330, `33330330, `33033330, `33003330, `33000330, `33000330, `00000000 ; N
	DW `00333000, `03303300, `33000330, `33000330, `33000330, `03303300, `00333000, `00000000 ; O
	DW `33333300, `03300330, `03300330, `03333300, `03300000, `03300000, `33330000, `00000000 ; P
	DW `03333000, `33003300, `33003300, `33003300, `33033300, `03333000, `00033300, `00000000 ; Q
	DW `33333300, `03300330, `03300330, `03333300, `03303300, `03300330, `33300330, `00000000 ; R
	DW `03333000, `33003300, `33300000, `03330000, `00033300, `33003300, `03333000, `00000000 ; S
	DW `33333300, `30330300, `00330000, `00330000, `00330000, `00330000, `03333000, `00000000 ; T
	DW `33003300, `33003300, `33003300, `33003300, `33003300, `33003300, `33333300, `00000000 ; U
	DW `33003300, `33003300, `33003300, `33003300, `33003300, `03333000, `00330000, `00000000 ; V
	DW `33000330, `33000330, `33000330, `33030330, `33333330, `33303330, `33000330, `00000000 ; W
	DW `33000330, `33000330, `03303300, `00333000, `00333000, `03303300, `33000330, `00000000 ; X
	DW `33003300, `33003300, `33003300, `03333000, `00330000, `00330000, `03333000, `00000000 ; Y
	DW `33333330, `33000330, `30003300, `00033000, `00330030, `03300330, `33333330, `00000000 ; Z
	DW `03333000, `03300000, `03300000, `03300000, `03300000, `03300000, `03333000, `00000000 ; [
	DW `33000000, `03300000, `00330000, `00033000, `00003300, `00000330, `00000030, `00000000 ; \
	DW `03333000, `00033000, `00033000, `00033000, `00033000, `00033000, `03333000, `00000000 ; ]
	DW `00030000, `00333000, `03303300, `33000330, `00000000, `00000000, `00000000, `00000000 ; ^
	DW `00000000, `00000000, `00000000, `00000000, `00000000, `00000000, `00000000, `33333333 ; _
	DW `00330000, `00330000, `00033000, `00000000, `00000000, `00000000, `00000000, `00000000 ; `
	DW `00000000, `00000000, `03333000, `00003300, `03333300, `33003300, `03330330, `00000000 ; a
	DW `33300000, `03300000, `03300000, `03333300, `03300330, `03300330, `33033300, `00000000 ; b
	DW `00000000, `00000000, `03333000, `33003300, `33000000, `33003300, `03333000, `00000000 ; c
	DW `00033300, `00003300, `00003300, `03333300, `33003300, `33003300, `03330330, `00000000 ; d
	DW `00000000, `00000000, `03333000, `33003300, `33333300, `33000000, `03333000, `00000000 ; e
	DW `00333000, `03303300, `03300000, `33330000, `03300000, `03300000, `33330000, `00000000 ; f
	DW `00000000, `00000000, `03330330, `33003300, `33003300, `03333300, `00003300, `33333000 ; g
	DW `33300000, `03300000, `03303300, `03330330, `03300330, `03300330, `33300330, `00000000 ; h
	DW `00330000, `00000000, `03330000, `00330000, `00330000, `00330000, `03333000, `00000000 ; i
	DW `00003300, `00000000, `00003300, `00003300, `00003300, `33003300, `33003300, `03333000 ; j
	DW `33300000, `03300000, `03300330, `03303300, `03333000, `03303300, `33300330, `00000000 ; k
	DW `03330000, `00330000, `00330000, `00330000, `00330000, `00330000, `03333000, `00000000 ; l
	DW `00000000, `00000000, `33003300, `33333330, `33333330, `33030330, `33000330, `00000000 ; m
	DW `00000000, `00000000, `33333000, `33003300, `33003300, `33003300, `33003300, `00000000 ; n
	DW `00000000, `00000000, `03333000, `33003300, `33003300, `33003300, `03333000, `00000000 ; o
	DW `00000000, `00000000, `33033300, `03300330, `03300330, `03333300, `03300000, `33330000 ; p
	DW `00000000, `00000000, `03330330, `33003300, `33003300, `03333300, `00003300, `00033330 ; q
	DW `00000000, `00000000, `33033300, `03330330, `03300330, `03300000, `33330000, `00000000 ; r
	DW `00000000, `00000000, `03333300, `33000000, `03333000, `00003300, `33333000, `00000000 ; s
	DW `00030000, `00330000, `03333300, `00330000, `00330000, `00330300, `00033000, `00000000 ; t
	DW `00000000, `00000000, `33003300, `33003300, `33003300, `33003300, `03330330, `00000000 ; u
	DW `00000000, `00000000, `33003300, `33003300, `33003300, `03333000, `00330000, `00000000 ; v
	DW `00000000, `00000000, `33000330, `33030330, `33333330, `33333330, `03303300, `00000000 ; w
	DW `00000000, `00000000, `33000330, `03303300, `00333000, `03303300, `33000330, `00000000 ; x
	DW `00000000, `00000000, `33003300, `33003300, `33003300, `03333300, `00003300, `33333000 ; y
	DW `00000000, `00000000, `33333300, `30033000, `00330000, `03300300, `33333300, `00000000 ; z
	DW `00033300, `00330000, `00330000, `33300000, `00330000, `00330000, `00033300, `00000000 ; {
	DW `00033000, `00033000, `00033000, `00000000, `00033000, `00033000, `00033000, `00000000 ; |
	DW `33300000, `00330000, `00330000, `00033300, `00330000, `00330000, `33300000, `00000000 ; }
	DW `03330330, `33033300, `00000000, `00000000, `00000000, `00000000, `00000000, `00000000 ; ~
	DW `00000000, `00000000, `00000000, `00000000, `00000000, `00000000, `00000000, `00000000 ; Delete
font_table_end: